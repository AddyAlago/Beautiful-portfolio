name: Tests â†’ One Allure + One Publish

on:
  push:
    branches: [ main ]
  pull_request:
  workflow_dispatch:
    inputs:
      projects:
        description: "Override Playwright projects for all suites (optional; usually leave empty)"
        required: false
        default: ""

jobs:
  run-matrix:
    name: Run ${{ matrix.suite }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - suite: desktop
            projects: "Desktop E2E"
          - suite: mobile
            projects: "Mobile E2E"
          - suite: a11y
            projects: "A11Y"
          - suite: visual
            projects: "Visual Desktop,Visual Mobile"
    uses: ./.github/workflows/core-tests.yml
    with:
      suite: ${{ matrix.suite }}
      # Allow a manual override via workflow_dispatch input; otherwise use the matrix mapping
      projects: ${{ github.event.inputs.projects || matrix.projects }}

  aggregate:
    name: Aggregate Allure & Publish
    runs-on: ubuntu-latest
    needs: [ run-matrix ]
    if: ${{ always() }}   # âœ… run even if some suites failed
    concurrency:
      group: gh-pages-deploy
      cancel-in-progress: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install Allure CLI
        run: |
          npm i -g allure-commandline@2.x
          allure --version || true

      - name: Download suite artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
        continue-on-error: true

      - name: Debug: show downloaded artifacts
        if: always()
        run: |
          echo "Artifacts tree (depth 3):"
          find artifacts -maxdepth 3 -type d -print || true
          echo "Files that look like allure results:"
          find artifacts -type f \( -name '*.json' -o -name '*.xml' \) | sed 's/^/  /' | head -n 200 || true

      - name: Merge allure-results (robust)
        shell: bash
        run: |
          shopt -s nullglob
          mkdir -p merged-allure-results
          # copy any directory that looks like allure results
          for d in artifacts/**/allure-results artifacts/allure-results-*; do
            if [ -d "$d" ]; then
              echo "Merging: $d"
              cp -r "$d"/* merged-allure-results/ || true
            fi
          done
          echo "Merged case files count:"
          find merged-allure-results -maxdepth 1 -type f \( -name '*.json' -o -name '*.xml' \) ! -name 'categories.json' ! -name 'executor.json' | wc -l
          ls -la merged-allure-results || true

      # OPTIONAL: preserve trend history by pulling prior gh-pages history
      - name: Pull existing history (optional)
        run: |
          git config --global user.email "actions@users.noreply.github.com"
          git config --global user.name "github-actions"
          git clone --depth 1 --branch gh-pages "https://github.com/${GITHUB_REPOSITORY}.git" gh-pages || true
          if [ -d gh-pages/allure/combined/history ]; then
            mkdir -p merged-allure-results/history
            cp -r gh-pages/allure/combined/history merged-allure-results/history || true
          fi

      - name: Generate combined Allure (only if data present)
        shell: bash
        run: |
          has_cases=$(find merged-allure-results -maxdepth 1 -type f \( -name '*.json' -o -name '*.xml' \) ! -name 'categories.json' ! -name 'executor.json' | wc -l)
          echo "has_cases=$has_cases"
          if [ "$has_cases" -gt 0 ]; then
            rm -rf allure-report
            allure generate merged-allure-results --clean -o allure-report
            echo "Generated combined Allure OK."
          else
            echo "No test-cases in merged-allure-results (only history/executor?). Creating placeholder."
            rm -rf allure-report
            mkdir -p allure-report
            cat > allure-report/index.html <<'HTML'
            <!doctype html><meta charset="utf-8">
            <title>No Results</title><body><h1>No Allure results available for this run.</h1></body>
            HTML
          fi

      - name: Prepare _site (combined, per-suite JSON, per-suite HTML)
        shell: bash
        run: |
          rm -rf _site
          mkdir -p _site/allure/combined _site/allure/json _site/playwright
          # Combined Allure
          cp -r allure-report/* _site/allure/combined/ || true
          # Per-suite raw JSON (for badges)
          shopt -s nullglob
          for d in artifacts/allure-results-*; do
            suite="${d##*/}"; suite="${suite#allure-results-}"
            mkdir -p "_site/allure/json/${suite}"
            cp -r "$d"/* "_site/allure/json/${suite}/" || true
          done
          # Per-suite Playwright HTML
          for d in artifacts/playwright-report-*; do
            suite="${d##*/}"; suite="${suite#playwright-report-}"
            mkdir -p "_site/playwright/${suite}"
            cp -r "$d"/* "_site/playwright/${suite}/" || true
          done

      - name: Build root index (combined + per-suite)
        if: always()
        run: |
          NOW=$(date -u +"%Y-%m-%d %H:%M:%SZ")
          SHA_SHORT=$(echo "$GITHUB_SHA" | cut -c1-7)
          mkdir -p _site
          cat > _site/index.html <<'HTML'
          <!doctype html>
          <html lang="en">
          <head>
            <meta charset="utf-8">
            <meta name="viewport" content="width=device-width, initial-scale=1">
            <title>Beautiful-portfolio â€¢ Reports</title>
            <style>
              :root{ --bg:#0b1220; --panel:#111a2f; --muted:#9fb0d1; --text:#e6eefc; --link:#80b3ff; --accent:#7c5cff; --accent2:#44d4b6; --card:#0f1629; }
              @media (prefers-color-scheme: light){
                :root{ --bg:#f8faff; --panel:#ffffff; --muted:#5b6b86; --text:#0e1116; --link:#2a62ff; --accent:#5b3df5; --accent2:#00a389; --card:#ffffff; }
              }
              *{box-sizing:border-box}
              body{
                margin:0; font:16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
                color:var(--text); background:radial-gradient(80rem 60rem at 20% -10%, rgba(124, 92, 255, .25), transparent 60%),
                                  radial-gradient(80rem 60rem at 90% 10%, rgba(68, 212, 182, .25), transparent 60%),
                                  var(--bg);
              }
              header{ padding:48px 20px 28px; text-align:center; }
              .title{font-size:clamp(24px, 3.2vw, 36px); margin:0 0 6px; letter-spacing:.3px}
              .subtitle{margin:0; color:var(--muted); font-size:14px}
              .meta{margin-top:10px; color:var(--muted); font-size:13px}
              .meta a{color:var(--link); text-decoration:none}
              .wrap{max-width:1100px; margin:22px auto 60px; padding:0 20px}
              h2{margin:22px 0 12px; font-size:clamp(18px, 2.2vw, 22px)}
              .grid{ display:grid; gap:16px; grid-template-columns: repeat( auto-fit, minmax(240px, 1fr) ); }
              .card{
                background:var(--card); border:1px solid rgba(255,255,255,.07);
                border-radius:16px; padding:18px; box-shadow:0 6px 18px rgba(0,0,0,.15);
                transition:transform .18s ease, box-shadow .18s ease, border-color .18s ease;
              }
              .card:hover{ transform:translateY(-3px); box-shadow:0 10px 24px rgba(0,0,0,.22); border-color:rgba(255,255,255,.18) }
              .tag{display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; letter-spacing:.2px; margin-bottom:10px; color:#fff}
              .pw{background:linear-gradient(90deg,var(--accent), #a477ff)}
              .allure{background:linear-gradient(90deg,var(--accent2), #39b7d4)}
              .card h3{margin:6px 0 8px; font-size:18px}
              .desc{margin:0 0 14px; color:var(--muted); font-size:14px; min-height:40px}
              .btns{display:flex; gap:10px; flex-wrap:wrap}
              .btn{
                display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:10px;
                border:1px solid rgba(255,255,255,.14); text-decoration:none; color:var(--text); font-size:14px;
                background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
              }
              .btn:hover{ border-color:rgba(255,255,255,.28) }
              .muted{ color:var(--muted) }
              footer{ text-align:center; padding:28px 20px 46px; color:var(--muted); font-size:13px }
              .hidden{opacity:.55; filter:grayscale(0.4)}
            </style>
          </head>
          <body>
            <header>
              <h1 class="title">Beautiful-portfolio â€” Reports</h1>
              <p class="subtitle">All suites aggregated into a single Allure, plus per-suite Playwright & Allure pages.</p>
              <div class="meta">
                Run <strong>#${{ github.run_number }}</strong> on <strong>${{ github.ref_name }}</strong> Â·
                commit <strong>__SHA_SHORT__</strong> Â·
                <span title="UTC timestamp">updated <strong>__NOW__</strong> UTC</span> Â·
                <a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" target="_blank" rel="noopener">view CI run</a>
              </div>
            </header>

            <main class="wrap">
              <h2>Allure (Combined)</h2>
              <section class="grid">
                <article class="card" data-probe="./allure/combined/">
                  <span class="tag allure">Allure</span>
                  <h3>All Suites â€” Combined</h3>
                  <p class="desc">Unified Allure report with trend history.</p>
                  <div class="btns"><a class="btn" href="./allure/combined/">Open Allure</a></div>
                </article>
              </section>

              <h2>Playwright HTML Reports (Per-Suite)</h2>
              <section class="grid">
                <article class="card" data-probe="./playwright/desktop/"><span class="tag pw">Playwright</span><h3>Desktop</h3><p class="desc">Full desktop browser suite.</p><div class="btns"><a class="btn" href="./playwright/desktop/">Open report</a></div></article>
                <article class="card" data-probe="./playwright/mobile/"><span class="tag pw">Playwright</span><h3>Mobile</h3><p class="desc">Mobile emulation / device profiles.</p><div class="btns"><a class="btn" href="./playwright/mobile/">Open report</a></div></article>
                <article class="card" data-probe="./playwright/a11y/"><span class="tag pw">Playwright</span><h3>A11Y</h3><p class="desc">Accessibility checks & violations.</p><div class="btns"><a class="btn" href="./playwright/a11y/">Open report</a></div></article>
                <article class="card" data-probe="./playwright/visual/"><span class="tag pw">Playwright</span><h3>Visual</h3><p class="desc">Visual regression reports.</p><div class="btns"><a class="btn" href="./playwright/visual/">Open report</a></div></article>
              </section>

              <h2>Allure Raw JSON (Per-Suite)</h2>
              <section class="grid">
                <article class="card" data-probe="./allure/json/desktop/"><span class="tag allure">Allure</span><h3>Desktop</h3><p class="desc">Raw Allure results for badges.</p><div class="btns"><a class="btn" href="./allure/json/desktop/">Open JSON</a></div></article>
                <article class="card" data-probe="./allure/json/mobile/"><span class="tag allure">Allure</span><h3>Mobile</h3><p class="desc">Raw Allure results for badges.</p><div class="btns"><a class="btn" href="./allure/json/mobile/">Open JSON</a></div></article>
                <article class="card" data-probe="./allure/json/a11y/"><span class="tag allure">Allure</span><h3>A11Y</h3><p class="desc">Raw Allure results for badges.</p><div class="btns"><a class="btn" href="./allure/json/a11y/">Open JSON</a></div></article>
                <article class="card" data-probe="./allure/json/visual/"><span class="tag allure">Allure</span><h3>Visual</h3><p class="desc">Raw Allure results for badges.</p><div class="btns"><a class="btn" href="./allure/json/visual/">Open JSON</a></div></article>
              </section>
            </main>

            <footer>
              <span class="muted">Built automatically by GitHub Actions.</span>
            </footer>

            <script>
              (async function(){
                const cards = document.querySelectorAll('.card[data-probe]');
                for (const card of cards){
                  const url = card.getAttribute('data-probe');
                  try {
                    const res = await fetch(url, { method: 'HEAD' });
                    if (!res.ok) card.classList.add('hidden');
                  } catch {
                    card.classList.add('hidden');
                  }
                }
              })();
            </script>
          </body>
          </html>
          HTML
          sed -i "s|__SHA_SHORT__|$SHA_SHORT|g" _site/index.html
          sed -i "s|__NOW__|$NOW|g" _site/index.html

      - name: Publish to gh-pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: _site
          force_orphan: false

      - name: Summary links
        if: always()
        run: |
          echo "### ðŸ“Š Published reports" >> $GITHUB_STEP_SUMMARY
          echo "- Root index: https://addyalago.github.io/Beautiful-portfolio/" >> $GITHUB_STEP_SUMMARY
          echo "- Combined Allure: https://addyalago.github.io/Beautiful-portfolio/allure/combined/" >> $GITHUB_STEP_SUMMARY
          echo "- Playwright Desktop: https://addyalago.github.io/Beautiful-portfolio/playwright/desktop/" >> $GITHUB_STEP_SUMMARY
          echo "- Playwright Mobile: https://addyalago.github.io/Beautiful-portfolio/playwright/mobile/" >> $GITHUB_STEP_SUMMARY
          echo "- Playwright A11Y: https://addyalago.github.io/Beautiful-portfolio/playwright/a11y/" >> $GITHUB_STEP_SUMMARY
          echo "- Playwright Visual: https://addyalago.github.io/Beautiful-portfolio/playwright/visual/" >> $GITHUB_STEP_SUMMARY
          echo "- JSON Desktop: https://addyalago.github.io/Beautiful-portfolio/allure/json/desktop/" >> $GITHUB_STEP_SUMMARY
          echo "- JSON Mobile: https://addyalago.github.io/Beautiful-portfolio/allure/json/mobile/" >> $GITHUB_STEP_SUMMARY
          echo "- JSON A11Y: https://addyalago.github.io/Beautiful-portfolio/allure/json/a11y/" >> $GITHUB_STEP_SUMMARY
          echo "- JSON Visual: https://addyalago.github.io/Beautiful-portfolio/allure/json/visual/" >> $GITHUB_STEP_SUMMARY
